{
  "id": "composite_emergency_exit_workflow",
  "version": "1.0.0",
  "category": "composite_problems",
  "subcategory": "advanced_defi",
  "difficulty": "hard",
  "title": "Emergency Exit: Withdraw, Remove Liquidity, Convert to BNB",
  "natural_language_templates": [
    "Emergency exit: withdraw all staked LP tokens, remove liquidity, unwrap WBNB to BNB, and verify balance",
    "Panic sell: emergency withdraw from pool at {pool_address}, remove all liquidity, convert to BNB",
    "Exit DeFi position: emergency withdraw LP from {pool_address}, remove WBNB/USDT liquidity, unwrap WBNB, verify BNB"
  ],
  "description": [
    "Emergency exit workflow to convert DeFi positions back to native BNB.",
    "",
    "This is a 5-step process:",
    "1. Emergency withdraw all staked LP tokens from SimpleRewardPool",
    "2. Approve LP tokens to PancakeSwap Router",
    "3. Remove liquidity to get WBNB and USDT",
    "4. Unwrap WBNB to native BNB",
    "5. Query final BNB balance to verify",
    "",
    "Technical details:",
    "- SimpleRewardPool: deployed dynamically (emergencyWithdraw())",
    "- PancakeSwap Router: 0x10ED43C718714eb63d5aA57B78B54704E256024E",
    "- WBNB: 0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c",
    "- USDT: 0x55d398326f99059fF775485246999027B3197955",
    "- WBNB/USDT LP: 0x16b9a82891338f9bA80E2D6970FddA79D1eb0daE",
    "",
    "Functions:",
    "- emergencyWithdraw(): Withdraw all staked tokens without rewards",
    "- removeLiquidityETH(token, liquidity, ...): Remove liquidity",
    "- withdraw(uint256): WBNB unwrap",
    "",
    "Note: Emergency withdraw forfeits pending rewards but guarantees LP recovery.",
    "BSC does NOT support ENS. Use hex addresses directly."
  ],
  "composite_structure": {
    "pattern": "emergency-exit",
    "optimal_steps": 5,
    "atomic_operations": [
      {
        "step": 1,
        "atomic_id": "emergency_withdraw",
        "role": "recovery",
        "description": "Emergency withdraw staked LP tokens"
      },
      {
        "step": 2,
        "atomic_id": "erc20_approve",
        "role": "approval",
        "description": "Approve LP tokens to Router"
      },
      {
        "step": 3,
        "atomic_id": "remove_liquidity_bnb_token",
        "role": "liquidity",
        "description": "Remove liquidity to get WBNB and USDT"
      },
      {
        "step": 4,
        "atomic_id": "wbnb_withdraw",
        "role": "key_operation",
        "description": "Unwrap WBNB to native BNB"
      },
      {
        "step": 5,
        "atomic_id": "query_bnb_balance",
        "role": "verification",
        "description": "Verify final BNB balance"
      }
    ],
    "interaction_config": {
      "max_rounds": 10,
      "optimal_steps": 5,
      "score_decay_formula": "base_score * min(1.0, optimal_steps / actual_steps)",
      "forced_submit_at_max": true
    }
  },
  "parameters": {
    "pool_address": {
      "type": "address",
      "role": "contract",
      "description": "SimpleRewardPool contract address",
      "dynamic": true,
      "generation": {
        "method": "from_env",
        "env_key": "simple_reward_pool_address"
      }
    },
    "router_address": {
      "type": "address",
      "role": "contract",
      "description": "PancakeSwap V2 Router contract address",
      "generation": {
        "method": "fixed",
        "value": "0x10ED43C718714eb63d5aA57B78B54704E256024E"
      }
    },
    "wbnb_address": {
      "type": "address",
      "role": "token",
      "description": "WBNB token address",
      "generation": {
        "method": "fixed",
        "value": "0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c"
      }
    },
    "usdt_address": {
      "type": "address",
      "role": "token",
      "description": "USDT token address",
      "generation": {
        "method": "fixed",
        "value": "0x55d398326f99059fF775485246999027B3197955"
      }
    },
    "lp_token_address": {
      "type": "address",
      "role": "token",
      "description": "WBNB/USDT LP token address",
      "generation": {
        "method": "fixed",
        "value": "0x16b9a82891338f9bA80E2D6970FddA79D1eb0daE"
      }
    },
    "token_decimals": {
      "type": "integer",
      "role": "calculation",
      "description": "Token decimal places",
      "generation": {
        "method": "fixed",
        "value": 18
      }
    },
    "slippage": {
      "type": "number",
      "unit": "percent",
      "role": "slippage_tolerance",
      "description": "Slippage tolerance percentage",
      "generation": {
        "method": "fixed",
        "value": 50.0
      }
    },
    "liquidity_percentage": {
      "type": "number",
      "unit": "percent",
      "role": "liquidity_amount",
      "description": "Percentage of LP tokens to remove",
      "generation": {
        "method": "fixed",
        "value": 100.0
      }
    }
  },
  "scoring_strategy": {
    "method": "atomic_validator_reuse",
    "key_operation_id": "wbnb_withdraw",
    "key_operation_step": 4
  },
  "validation": {
    "pre_conditions": [
      {
        "type": "staked_lp_balance",
        "description": "Agent must have staked LP tokens in SimpleRewardPool",
        "min_balance": "0.5 LP"
      }
    ],
    "post_conditions": [
      {
        "type": "transaction_success",
        "weight": 0.2,
        "description": "WBNB withdraw transaction executed successfully"
      },
      {
        "type": "lp_recovered",
        "weight": 0.2,
        "description": "LP tokens recovered from staking"
      },
      {
        "type": "liquidity_removed",
        "weight": 0.2,
        "description": "Liquidity removed successfully"
      },
      {
        "type": "bnb_balance_increase",
        "weight": 0.3,
        "description": "BNB balance increased after unwrap"
      },
      {
        "type": "balance_verified",
        "weight": 0.1,
        "description": "Final BNB balance was verified"
      }
    ]
  },
  "metadata": {
    "tags": [
      "defi",
      "emergency",
      "exit",
      "withdraw",
      "liquidity",
      "unwrap",
      "advanced",
      "hard"
    ],
    "estimated_gas": 800000,
    "requires_approval": true,
    "difficulty_notes": [
      "Five-step emergency exit workflow",
      "Emergency withdraw forfeits rewards",
      "Must handle LP token approval",
      "Convert all positions to native BNB"
    ]
  }
}

